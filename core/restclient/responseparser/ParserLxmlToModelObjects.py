'''
Created on Oct 15, 2012

@author: dawood
'''

##################### XML to/from dict ########################

# Create python xml structures compatible with
# http://search.cpan.org/~grantm/XML-Simple-2.18/lib/XML/Simple.pm
from common import *
from LxmlTools import etree, d2xml, xml2d
from itertools import groupby
import re
import copy
from modelgenerator import agilitymodel
from modelgenerator.agilitymodel import Assetlist, Linklist, Tasklist

modelClassFactory = lambda name: getattr(agilitymodel, name)
#from ParserLxml import xml2d, d2xml, modifyMap

COMPONENT_NAME = 'XML_PARSER_Lxml_To_Model_Objects'
from logger import getLogger
logger = getLogger(COMPONENT_NAME)

CDATA_KEY = '__CDATA__'

@persist
def parse(xmlText, assetType=None, removeNSPrefix=True):
    '''
    parses xmlText using lxml library into composite of smart objects
    
    @param xmlText: xml text to parse
    @param assetType: type of first level asset(s) in the xmlText
    @param removeNSPrefix: if True, ns prefix will be removed from xml tag names, default to True
    @return: composite of AbstractProxy object graph
    '''
    if not xmlText:
        return xmlText
    e = etree.XML(xmlText)
    dct = xml2d(e, removeNSPrefix, loadAttrs=True)
    k, v = dct.items().pop()
    asset = modelClassFactory(k)()
    #Note the agilitymodel package with it's special __init__ file is used as an object factory
    asset._loadAttrs(v, modelClassFactory)
    childAttrName = {Assetlist : 'Asset',
                        Linklist : 'link',
                        Tasklist : 'Task'
                        }
    if isinstance(asset, (Assetlist, Linklist, Tasklist)):
        childAttr = getattr(asset, childAttrName[type(asset)])
        return childAttr if isinstance(childAttr, (list, tuple)) else [childAttr]
    else:
        return asset

def basicTest():
    templateXML = '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><ns1:Template xmlns:ns1="http://servicemesh.com/agility/api"><ns1:id>109</ns1:id><ns1:name>jenkins</ns1:name><ns1:description>SM Linux (RHEL 5.8 x64) Server</ns1:description><ns1:uuid>0387430d-a7fe-4e19-80e0-697689744b3b</ns1:uuid><ns1:assetType><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/assettype/22</ns1:href><ns1:type>application/com.servicemesh.agility.api.AssetType+xml</ns1:type><ns1:name>template</ns1:name><ns1:id>22</ns1:id><ns1:position>0</ns1:position></ns1:assetType><ns1:top>false</ns1:top><ns1:assetPath>/Root/Agility Shell</ns1:assetPath><ns1:detailedAssetPath>/Root:#ID#1:#TYPE#VMContainer/Agility Shell:#ID#8:#TYPE#VMProject</ns1:detailedAssetPath><ns1:lifecycleVersion>-1</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:domain><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/domain/1</ns1:href><ns1:type>application/com.servicemesh.agility.api.Domain+xml</ns1:type><ns1:name>domain1</ns1:name><ns1:id>1</ns1:id><ns1:position>0</ns1:position></ns1:domain><ns1:creator><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/user/1</ns1:href><ns1:type>application/com.servicemesh.agility.api.User+xml</ns1:type><ns1:name>admin</ns1:name><ns1:id>1</ns1:id><ns1:position>0</ns1:position></ns1:creator><ns1:created>2013-04-09T20:15:46-04:00</ns1:created><ns1:lockType>0</ns1:lockType><ns1:lastModified>2013-04-09T21:36:55-04:00</ns1:lastModified><ns1:policyAssignment><ns1:id>1</ns1:id><ns1:name>AgilityManager-In</ns1:name><ns1:uuid>e44bf632-647f-43e1-839d-dcb4a4d96d0c</ns1:uuid><ns1:top>false</ns1:top><ns1:assetPath>/Root/Agility Shell/jenkins</ns1:assetPath><ns1:detailedAssetPath></ns1:detailedAssetPath><ns1:lifecycleVersion>0</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:applyToSelf>true</ns1:applyToSelf><ns1:applyChildrenDepth>0</ns1:applyChildrenDepth><ns1:allowChildrenOverride>true</ns1:allowChildrenOverride><ns1:policy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ns1:VersionedItemLink"><ns1:rel>down</ns1:rel><ns1:href>policy/8</ns1:href><ns1:type>application/com.servicemesh.agility.api.Policy+xml</ns1:type><ns1:name>AgilityManager-In</ns1:name><ns1:id>8</ns1:id><ns1:position>0</ns1:position><ns1:slot>8d0b6193-b93e-44fd-877c-20b80cc2fc51</ns1:slot><ns1:version>1</ns1:version><ns1:latest>true</ns1:latest><ns1:slotId>7</ns1:slotId><ns1:versionStatus>active</ns1:versionStatus><ns1:lockType>0</ns1:lockType></ns1:policy><ns1:policyTypeName>Firewall</ns1:policyTypeName><ns1:itemClass>VMTemplate</ns1:itemClass><ns1:itemId>109</ns1:itemId><ns1:itemName>jenkins</ns1:itemName></ns1:policyAssignment><ns1:policyAssignment><ns1:id>2</ns1:id><ns1:name>Agility_Default-Inbound</ns1:name><ns1:uuid>ed0d307e-e78d-46e3-805d-d0a2f69e3794</ns1:uuid><ns1:top>false</ns1:top><ns1:assetPath>/Root/Agility Shell/jenkins</ns1:assetPath><ns1:detailedAssetPath></ns1:detailedAssetPath><ns1:lifecycleVersion>0</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:applyToSelf>true</ns1:applyToSelf><ns1:applyChildrenDepth>0</ns1:applyChildrenDepth><ns1:allowChildrenOverride>true</ns1:allowChildrenOverride><ns1:policy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ns1:VersionedItemLink"><ns1:rel>down</ns1:rel><ns1:href>policy/6</ns1:href><ns1:type>application/com.servicemesh.agility.api.Policy+xml</ns1:type><ns1:name>Agility_Default-Inbound</ns1:name><ns1:id>6</ns1:id><ns1:position>0</ns1:position><ns1:slot>c0211eee-9b6e-4d1c-9a29-4bbe8304ea89</ns1:slot><ns1:version>1</ns1:version><ns1:latest>true</ns1:latest><ns1:slotId>5</ns1:slotId><ns1:versionStatus>active</ns1:versionStatus><ns1:lockType>0</ns1:lockType></ns1:policy><ns1:policyTypeName>Firewall</ns1:policyTypeName><ns1:itemClass>VMTemplate</ns1:itemClass><ns1:itemId>109</ns1:itemId><ns1:itemName>jenkins</ns1:itemName></ns1:policyAssignment><ns1:policyAssignment><ns1:id>3</ns1:id><ns1:name>HTTP_904_SHADOW</ns1:name><ns1:uuid>b340341e-2599-4456-8760-f708af0ed0a5</ns1:uuid><ns1:top>false</ns1:top><ns1:assetPath>/Root/Agility Shell/jenkins</ns1:assetPath><ns1:detailedAssetPath></ns1:detailedAssetPath><ns1:lifecycleVersion>0</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:applyToSelf>true</ns1:applyToSelf><ns1:applyChildrenDepth>0</ns1:applyChildrenDepth><ns1:allowChildrenOverride>true</ns1:allowChildrenOverride><ns1:policy xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ns1:VersionedItemLink"><ns1:rel>down</ns1:rel><ns1:href>policy/17</ns1:href><ns1:type>application/com.servicemesh.agility.api.Policy+xml</ns1:type><ns1:name>HTTP_904_SHADOW</ns1:name><ns1:id>17</ns1:id><ns1:position>0</ns1:position><ns1:version>-1</ns1:version><ns1:latest>false</ns1:latest><ns1:versionStatus>inprogress</ns1:versionStatus><ns1:lockType>0</ns1:lockType></ns1:policy><ns1:policyTypeName>Firewall</ns1:policyTypeName><ns1:itemClass>VMTemplate</ns1:itemClass><ns1:itemId>109</ns1:itemId><ns1:itemName>jenkins</ns1:itemName></ns1:policyAssignment><ns1:parent><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/project/8</ns1:href><ns1:type>application/com.servicemesh.agility.api.Project+xml</ns1:type><ns1:name>Agility Shell</ns1:name><ns1:id>8</ns1:id><ns1:position>0</ns1:position></ns1:parent><ns1:numInstances>1</ns1:numInstances><ns1:topology><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/topology/8</ns1:href><ns1:type>application/com.servicemesh.agility.api.Topology+xml</ns1:type><ns1:name>Agility Shell</ns1:name><ns1:id>8</ns1:id><ns1:position>0</ns1:position></ns1:topology><ns1:cloud><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/cloud/2</ns1:href><ns1:type>application/com.servicemesh.agility.api.Cloud+xml</ns1:type><ns1:name>EC2</ns1:name><ns1:id>2</ns1:id><ns1:position>0</ns1:position></ns1:cloud><ns1:factory>false</ns1:factory><ns1:stack><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/stack/4</ns1:href><ns1:type>application/com.servicemesh.agility.api.Stack+xml</ns1:type><ns1:name>SM Linux (RHEL 5.8 x64) Server</ns1:name><ns1:id>4</ns1:id><ns1:position>0</ns1:position></ns1:stack><ns1:image><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/image/11</ns1:href><ns1:type>application/com.servicemesh.agility.api.Image+xml</ns1:type><ns1:name>SM-RHEL5.8s-x86_64-v9.0-0.r138</ns1:name><ns1:id>11</ns1:id><ns1:position>0</ns1:position></ns1:image><ns1:model>m1.xlarge</ns1:model><ns1:location>ap-southeast-2a</ns1:location><ns1:packages><ns1:rel>down</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/package/18</ns1:href><ns1:type>application/com.servicemesh.agility.api.Package+xml</ns1:type><ns1:name>Java 1.7 Update 10 JDK</ns1:name><ns1:id>18</ns1:id><ns1:position>0</ns1:position></ns1:packages><ns1:packages><ns1:rel>down</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/package/17</ns1:href><ns1:type>application/com.servicemesh.agility.api.Package+xml</ns1:type><ns1:name>Jenkins Install Package</ns1:name><ns1:id>17</ns1:id><ns1:position>0</ns1:position></ns1:packages><ns1:packages><ns1:rel>down</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/package/15</ns1:href><ns1:type>application/com.servicemesh.agility.api.Package+xml</ns1:type><ns1:name>GIT Installation Package</ns1:name><ns1:id>15</ns1:id><ns1:position>0</ns1:position></ns1:packages><ns1:credential><ns1:id>79</ns1:id><ns1:name>jenkins904-sdawood</ns1:name><ns1:description>Key for Jenkins on 9.0.4 Sydney EC2</ns1:description><ns1:uuid>6f148d6a-c8ce-4d6f-bf0b-cc7e7e3fdf42</ns1:uuid><ns1:assetType><ns1:rel>up</ns1:rel><ns1:href>assettype/28</ns1:href><ns1:type>application/com.servicemesh.agility.api.AssetType+xml</ns1:type><ns1:name>credential</ns1:name><ns1:id>28</ns1:id><ns1:position>0</ns1:position></ns1:assetType><ns1:top>false</ns1:top><ns1:assetPath>/Root/Agility Shell</ns1:assetPath><ns1:detailedAssetPath>/Root:#ID#1:#TYPE#VMContainer/Agility Shell:#ID#8:#TYPE#VMProject</ns1:detailedAssetPath><ns1:lifecycleVersion>-1</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:domain><ns1:rel>up</ns1:rel><ns1:href>domain/1</ns1:href><ns1:type>application/com.servicemesh.agility.api.Domain+xml</ns1:type><ns1:name>domain1</ns1:name><ns1:id>1</ns1:id><ns1:position>0</ns1:position></ns1:domain><ns1:creator><ns1:rel>up</ns1:rel><ns1:href>user/1</ns1:href><ns1:type>application/com.servicemesh.agility.api.User+xml</ns1:type><ns1:name>admin</ns1:name><ns1:id>1</ns1:id><ns1:position>0</ns1:position></ns1:creator><ns1:created>2013-04-09T20:15:06-04:00</ns1:created><ns1:lockType>0</ns1:lockType><ns1:lastModified>2013-04-09T20:15:06-04:00</ns1:lastModified><ns1:parent><ns1:rel>up</ns1:rel><ns1:href>project/8</ns1:href><ns1:type>application/com.servicemesh.agility.api.Project+xml</ns1:type><ns1:name>Agility Shell</ns1:name><ns1:id>8</ns1:id><ns1:position>0</ns1:position></ns1:parent><ns1:credentialType>SSH</ns1:credentialType><ns1:privateKey>1a421c2020f5be41f08092ae923b48f230817b66d53c1c5a4beaf763275e8467e02fd201f16e9ad29e38e3959220d320278e14ecd605492a92dd79d1da7d9a0040bc6777e90ab07d45897ffee6d14f8aa4d624a314224c40291bb38d4f57adbc3685fbcab3febcb0ef4244c85b4a356747f363179cb247fd181e07e01e8439c89567a5088c8101d7ff153e5f2857feb81b7ab06349cebb2d7e599e726cbfdae25db99880a49471b09dfb8a5be3ab283dead0a069738730d241798ca800dbbb96baf3cca93d44f85eb9a7053d77e7e1d89e9d0c13766adce50a69570b1681132360e7be1b78f5a252eeb2c15971c119b26a86a966d11997a6f8f8e9a8614b9981aac084b012e3a60cf4a6883c3053c156fab58c5fc778dda8cc14e2825ad16badfa515b1b2eb3ca458d6048def9e1e16f64b8dc34a72b519294bcf02ff1e512465497949f4dd8075222403fdfe6a1713e0d673ff1494cb404b170962f59f6a5bb2757a8581d150554aab5c7f60aa2330778c72032c09b7b9509b35812a72c5d5054cc613af0fd48a7e830f95ae1e529c3b6bddbaf023cacdf2d395accf4acd9ed2ea99a0d839d041254cea54fc4830ac5d07d6979746d46947c32553895529775122e772c26a50e749147a47050a31e701fde1a17d6f42b8dc92f1e51b765e4ad5d848137eede3e912c2c6bc372edfd2a8ac29b6e6d9066b605bd81c8d93c0f3999ad4f58209b47eaae9117b29df416fce43da285beb0ec4196e8dfb850a4c62bed19be3393509e7cf4c11d820e5cd9aca199b27b5a1995318e0ed8574d16dc347b79b57de677bca7f0957089bbadb18b8b3056f8a8ba4a4fb5e4c376973754fd2b8e815ffc7268fa811660bf75953266fc206892452efe4caa4fafe8880cadc24312b8bd10a78ac90188bedef072985f26a276d2a52080f4bcd620e9711621af6cebbde5e43baa4e81d3bda6cd9fb66c27f6f4376a3f44c1c94fe817875a6661df0a224620330ce37f97354038fb017e38b6106acec02e3f4aeb53702e13353c63f65863a325ca91252edba2a0b05034aae23cc5bf84660e9c75f7e6987da532b3d815716e2d86b436f4143cdff408a0f1b02b616838eeb61896a124dab5428cecdf54183f9728a3b351814f3d034fe90b31ddefc4ba1fd1a1dcef6d845ab7e687ea98841d8849fac6b0855690aac2c518af5fc091ec4f8fb154238f5b99c667b52d65e8505713d66deae625f953340195b0ea7641d282c55bd18a4d1668a6602cb2c62cbf9906432d30837543e853b6b45e96106944f8f3dc2a1685b7b6e836ab3f7a04ab15100753497f7d5eef44d9399d5f276bbf80eaa9ba75900f8177fd2aa8e618525ab0060502e8206f73ba5bfed7c4f327787966b769f2b5d44b9e472b63a9e3b68bc11a8c671b4b6d54340e216ff836f005cd0eaabcdeaa9660031043ccba0f70570732036169b37bbad3259c6fbbbce95a602fb57c43ce2c857a580c81c89b6afb0d5e83bc0ababe4363725691734869e48f5de2a6cbcd67df0b859d4bfe0c35acb4c3b0e051ec866b38874a44058e1d9317f9c7ecc64998298964c211b33da4fd1e41f878f233e337326c22dffc1806091c1464c7b87214a85f4b08c7f3805c71fdcf2686acb48228df35123bf602708d6e2869f0d3a4163ebfb8d9a235029c340a3d777c73d0150ecec1ea2e5dfd8cab4cc0f49384519a882f74957a6e8f698434ce07adbbafb22170f980a85e0d1349b613a70846a2849d4104485cb51f1316851f634c93e33b0374bdbec463a7f302fefc454a63d5c0dc5b801ee07ebefac203e641463d14459029f5635de0d4b119427888d7b96c48eb69a5b16a6cd57d1c004a0002f04d8c47148ddfd32d1f7f2fd8ada2d7132eac277a32d181911cdecc76f52c04bc36f53bfb146244a38bbdab6e78e1b70da2c4c3307b98c301f8c7145e498ddb98ca96dfe41b793636151bd332be30d9d98469831b68025b369725a643a0f49d17c161ed71bdd8faa334ecff3fbba8d97a889966c733ef89aca282730d1b10e66979a29cb59729ba6ebcd5ad4aeb49ecef97d6d31a68639da0fee9d4e3d4c3ea1785fab8597c4741f6a3dd61dd8282f9241e9fb3979f9dec1e04c092bea282a1f6598ada4bd011c729cb0588499d852607ddc7ed0f237a43431a0160e1bd7cb3e93f399259a7c2fa0c0e84be965640930de5fb13013762b2322a7d74436e1503ce4e7de536d9636b9fdcd4879ab5882f0af7a4ab2b380a207f43917d328db94f18ede1207e4ae7303a08ac7ec9d7b7a020f4262983626e6638f1368fc70698287459d5afcd839d7872f2eeb2bffbda4b886834d03b6f49441c32355825d5b819e721f6e5a1cc</ns1:privateKey><ns1:cloud><ns1:id>2</ns1:id><ns1:name>EC2</ns1:name><ns1:description>EC2 Training Sydney</ns1:description><ns1:uuid>328f3aed-34aa-42d5-85eb-7db4132de7d9</ns1:uuid><ns1:top>false</ns1:top><ns1:cloudType><ns1:rel>up</ns1:rel><ns1:href>cloudtype/1</ns1:href><ns1:type>application/com.servicemesh.agility.api.CloudType+xml</ns1:type><ns1:name>Amazon EC2 Cloud</ns1:name><ns1:id>1</ns1:id><ns1:position>0</ns1:position></ns1:cloudType></ns1:cloud></ns1:credential><ns1:resources xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ns1:NetworkInterface"><ns1:id>1324</ns1:id><ns1:name>Network Adapter</ns1:name><ns1:uuid>3dc57781-c1d4-4707-aed5-cacaee116929</ns1:uuid><ns1:top>false</ns1:top><ns1:assetPath></ns1:assetPath><ns1:detailedAssetPath></ns1:detailedAssetPath><ns1:lifecycleVersion>-1</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:resourceType>Ethernet Adapter</ns1:resourceType><ns1:quantity>0.0</ns1:quantity><ns1:hostResource>public</ns1:hostResource><ns1:network><ns1:rel>up</ns1:rel><ns1:href>https://54.252.95.45:8443/agility/api/current/network/1</ns1:href><ns1:type>application/com.servicemesh.agility.api.Network+xml</ns1:type><ns1:name>public</ns1:name><ns1:id>1</ns1:id><ns1:position>0</ns1:position></ns1:network></ns1:resources><ns1:resources><ns1:id>1328</ns1:id><ns1:name>8 EC2 Compute Units</ns1:name><ns1:description>m1.xlarge.cpu</ns1:description><ns1:uuid>30e7e4ab-8ba0-4a79-be27-3b5649d8fe10</ns1:uuid><ns1:top>false</ns1:top><ns1:assetPath></ns1:assetPath><ns1:detailedAssetPath></ns1:detailedAssetPath><ns1:applicationType>application/com.servicemesh.agility.api.Resource+xml</ns1:applicationType><ns1:lifecycleVersion>-1</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:resourceType>Processor</ns1:resourceType><ns1:units>Compute Units</ns1:units><ns1:quantity>8.0</ns1:quantity></ns1:resources><ns1:resources><ns1:id>1329</ns1:id><ns1:name>15GB Memory</ns1:name><ns1:description>m1.xlarge.memory</ns1:description><ns1:uuid>bd132851-513a-4967-bbac-64433a5d5f9b</ns1:uuid><ns1:top>false</ns1:top><ns1:assetPath></ns1:assetPath><ns1:detailedAssetPath></ns1:detailedAssetPath><ns1:applicationType>application/com.servicemesh.agility.api.Resource+xml</ns1:applicationType><ns1:lifecycleVersion>-1</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:resourceType>Memory</ns1:resourceType><ns1:units>GB</ns1:units><ns1:quantity>16.0</ns1:quantity></ns1:resources><ns1:resources><ns1:id>1330</ns1:id><ns1:name>1690GB Hard Drive</ns1:name><ns1:description>m1.xlarge.disk</ns1:description><ns1:uuid>d7ae7e7b-c8cc-492d-a0a7-d23108c32253</ns1:uuid><ns1:top>false</ns1:top><ns1:assetPath></ns1:assetPath><ns1:detailedAssetPath></ns1:detailedAssetPath><ns1:applicationType>application/com.servicemesh.agility.api.Resource+xml</ns1:applicationType><ns1:lifecycleVersion>-1</ns1:lifecycleVersion><ns1:removable>true</ns1:removable><ns1:resourceType>Disk Drive</ns1:resourceType><ns1:units>GB</ns1:units><ns1:quantity>1690.0</ns1:quantity></ns1:resources><ns1:onboarded>false</ns1:onboarded></ns1:Template>'
    parse(templateXML)

if __name__ == '__main__':
    basicTest()